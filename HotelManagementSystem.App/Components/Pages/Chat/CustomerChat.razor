@page "/customer-chat"
@inject ChatService ChatService

<h3>Customer Chat</h3>

<input @bind="UserName" placeholder="Your Name" />
<textarea @bind="Message" placeholder="Type a message..." />
<button @onclick="SendMessage">Send</button>

<ul>
    @foreach (var msg in Messages)
    {
        <li><strong>@msg.SenderType (@msg.User):</strong> @msg.Text</li>
    }
</ul>

@code {
    private string UserName = "Customer";
    private string Message;
    private List<(string SenderType, string User, string Text)> Messages = new();

    protected override async Task OnInitializedAsync()
    {
        ChatService.OnMessageReceived += async (senderType, user, message) =>
              {
                  await InvokeAsync(() =>
                  {
                      Messages.Add((senderType, user, message));
                      StateHasChanged();
                  });
              };

        await ChatService.StartConnectionAsync("https://localhost:7014", "Customer");
    }

    private async Task SendMessage()
    {
        await ChatService.SendMessageAsync(UserName, Message);
        Message = string.Empty;
    }

    public async ValueTask DisposeAsync()
    {
        await ChatService.StopConnectionAsync();
    }
}